<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>t4kpod – Flipbook iFrame</title>

  <!-- Systemcursor im iFrame vollständig aus + keine Scrollbars -->
  <style>
    html, body, body *, body *:hover, body *:focus, body *:active,
    img, video, canvas, svg, figure, [role="button"], [href], button, a,
    :fullscreen, ::backdrop { cursor: none !important; }
    html, body {
      margin: 0; padding: 0;
      overflow: hidden !important; /* keine Scrollbars */
      width: 100%; height: 100%;
      background: transparent;
    }
    ::-webkit-scrollbar { display: none; }
    * { scrollbar-width: none; -ms-overflow-style: none; }

    @keyframes t4kpod-spin { to { transform: rotate(360deg) } }

    /* (optional) UI-Cosmetics aus deinem bestehenden Code … */
  </style>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/legacy/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/legacy/build/pdf.worker.min.js";
  </script>
  <link href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
</head>
<body>

  <!-- Dein Flipbook-Layout (verkürzt) -->
  <div id="t4kpod-flipbook-root" style="width:100%;max-width:1100px;height:80vh;margin:0 auto;border-radius:16px;overflow:visible;background:transparent;">
    <div class="t4kpod-wrap" style="width:100%;height:100%;position:relative;display:flex;flex-direction:column;align-items:center;">
      <div class="t4kpod-topbar" style="padding:12px;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;">
        <div class="t4kpod-pill" style="display:inline-flex;gap:8px;background:rgba(255,255,255,.06);color:#e6e8ee;border:1px solid rgba(255,255,255,.1);border-radius:999px;padding:8px 12px;font:500 13px/1.2 system-ui,Inter,Arial;backdrop-filter:blur(6px);">
          <button class="t4kpod-icon" data-act="prev" style="all:unset;color:#e6e8ee;display:inline-grid;place-items:center;width:32px;height:32px;border-radius:10px;" title="Zurück">
            <svg fill="none" height="18" width="18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </button>
          <button class="t4kpod-icon" data-act="next" style="all:unset;color:#e6e8ee;display:inline-grid;place-items:center;width:32px;height:32px;border-radius:10px;" title="Weiter">
            <svg fill="none" height="18" width="18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </button>
        </div>
      </div>

      <div class="t4kpod-viewer" style="position:relative;flex:1;display:grid;place-items:center;min-height:320px;padding-bottom:32px;width:100%;max-width:100%;">
        <div class="stf__parent" id="t4kpod-flip" style="will-change:transform;min-width:280px;min-height:320px;width:100%;max-width:4000px;display:block;transform:scale(0.8);transform-origin:center center;"></div>
        <div id="t4kpod-loader" style="position:absolute;inset:0;display:none;place-items:center;gap:12px;color:#e6e8ee;font:500 14px/1.2 system-ui,Inter,Arial;">
          <div class="t4kpod-spin" style="width:42px;height:42px;border-radius:50%;border:3px solid rgba(255,255,255,.15);border-top-color:#00d1b2;animation:t4kpod-spin 1s linear infinite"></div>
          <div>PDF wird geladen…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- iFrame → Host: Maus-Koordinaten & Hover sauber senden -->
  <script>
  (function(){
    // Empfohlen: host-spezifisch setzen, z.B. 'https://dein-name.cargo.site'
    // const PARENT_ORIGIN = 'https://DEINE-DOMAIN.tld';
    const PARENT_ORIGIN = document.referrer?.split('/').slice(0,3).join('/') || '*';

    const HOVER_SELECTOR = 'a, button, [role="button"], [href], input, select, textarea, canvas, [data-link]';
    const isInteractive = (el)=>{ try { return !!(el && el.closest && el.closest(HOVER_SELECTOR)); } catch(e){ return false; } };

    // Damit es nicht "rattert": per rAF bündeln
    let lastHover = null;
    let mx = 0, my = 0, dirty = false;

    window.addEventListener('mousemove', (e) => {
      mx = e.clientX; my = e.clientY;
      const hover = !!isInteractive(e.target);
      if (hover !== lastHover) { lastHover = hover; dirty = true; }
      else { dirty = true; }
    }, { passive:true });

    function tick(){
      if (dirty){
        const payload = { x: mx, y: my };
        if (lastHover !== null) payload.hover = lastHover;
        try { window.parent.postMessage({ type: 'cursor', ...payload }, PARENT_ORIGIN); } catch(e){}
        dirty = false;
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    window.addEventListener('mouseenter', ()=> {
      try { window.parent.postMessage({ type: 'cursor:enter' }, PARENT_ORIGIN); } catch(e){}
    }, true);
    window.addEventListener('mouseleave', ()=> {
      try { window.parent.postMessage({ type: 'cursor:leave' }, PARENT_ORIGIN); } catch(e){}
    }, true);
  })();
  </script>

  <!-- Dein Flipbook-Code (PDF -> Images -> PageFlip) -->
  <script>
  (function(){
    "use strict";
    const PDF_URL = "https://cdn.jsdelivr.net/gh/piepdesign/t4kpod@main/t4kpod.pdf";
    const container = document.getElementById("t4kpod-flip");
    const pageEl = document.getElementById("t4kpod-page");
    const pagesEl = document.getElementById("t4kpod-pages");
    const loader = document.getElementById("t4kpod-loader");
    const root = document.getElementById("t4kpod-flipbook-root");
    const viewer = root.querySelector('.t4kpod-viewer');

    const state = { zoom: 0.8 };
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const setLoading = (on)=> loader.style.display = on ? 'grid' : 'none';

    async function pdfToImages(url, pixelRatio){
      const doc = await pdfjsLib.getDocument({ url }).promise;
      const total = doc.numPages;
      if (pagesEl) pagesEl.textContent = String(total);
      const pages = [];
      for(let i=1;i<=total;i++){
        const page = await doc.getPage(i);
        const viewport = page.getViewport({ scale: pixelRatio });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: ctx, viewport }).promise;
        pages.push(canvas.toDataURL('image/png'));
      }
      return pages;
    }

    function initFlip(pages){
      const tmp = new Image();
      tmp.onload = ()=>{
        const viewerRect = viewer.getBoundingClientRect();
        const aspect = tmp.height / tmp.width;
        const maxH = Math.max(320, Math.min(viewerRect.height - 48, 2200));
        const baseH = Math.round(maxH);
        const baseW = Math.round(baseH / aspect);

        const flip = new St.PageFlip(container, {
          width: baseW,
          height: baseH,
          size: 'stretch',
          minWidth: 280,
          minHeight: 320,
          maxWidth: 2000,
          maxHeight: 2200,
          showPageCorners: true,
          flippingTime: 650,
          drawShadow: false,
          autoSize: true,
          mobileScrollSupport: true,
          showCover: true,
          usePortrait: true
        });

        const htmlPages = pages.map((src, idx) => {
          const el = document.createElement('div');
          el.className = 't4kpod-page';
          el.setAttribute('data-density', (idx === 0 || idx === pages.length - 1) ? 'hard' : 'soft');
          el.innerHTML = `<img src="${src}" alt="Seite ${idx+1}"/>`;
          return el;
        });

        flip.loadFromHTML(htmlPages);
        if (pageEl) pageEl.textContent = '1';

        const q = (sel)=> root.querySelector(sel);
        const btnPrev = q('[data-act="prev"]');
        const btnNext = q('[data-act="next"]');
        btnPrev && btnPrev.addEventListener('click', ()=> flip.flipPrev());
        btnNext && btnNext.addEventListener('click', ()=> flip.flipNext());
      };
      tmp.src = pages[0];
    }

    (async function run(){
      try{
        setLoading(true);
        const pixelRatio = window.devicePixelRatio > 1 ? 2.4 : 1.6;
        const pages = await pdfToImages(PDF_URL, pixelRatio);
        setLoading(false);
        initFlip(pages);
      }catch(err){
        console.error(err);
        setLoading(false);
        const msg = document.createElement('div');
        msg.style.cssText = 'color:#fff;padding:24px;background:rgba(0,0,0,.4);border-radius:12px;';
        msg.textContent = 'Fehler beim Laden der PDF: ' + err.message;
        viewer.appendChild(msg);
      }
    })();
  })();
  </script>

</body>
</html>
